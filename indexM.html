<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcadores del Pueblo - Móvil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        #questionContainer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1;
            display: none;
        }
        .option {
            margin-bottom: 8px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f9f9f9;
        }
        .option:hover {
            background-color: #e9e9e9;
        }
        #score {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="questionContainer">
        <h3 id="question"></h3>
        <div id="options"></div>
        <p id="feedback"></p>
    </div>
    <span id="score">Puntos: 0</span>

    <script>
        const map = L.map('map').setView([41.5, -5.7], 13); // Coordenadas de Zamora
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let userLocation = null;
        let currentMarker = null;
        let score = 0;
        let markersData = [];

        // Cargar marcadores desde el archivo JSON
        fetch('marcadores.json')
            .then(response => response.json())
            .then(data => {
                markersData = data;
                markersData.forEach(markerData => {
                    L.marker([markerData.lat, markerData.lng]).addTo(map)
                        .bindPopup(markerData.title);
                });
            })
            .catch(error => console.error('Error al cargar los marcadores:', error));

        // Función para calcular la distancia entre dos puntos (en metros)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Función para mostrar la pregunta
        function showQuestion(markerData) {
            currentMarker = markerData;
            document.getElementById('question').innerText = markerData.question;
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            for (let i = 0; i < markerData.options.length; i++) {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('option');
                optionDiv.innerText = `${i + 1}. ${markerData.options[i]}`;
                optionDiv.addEventListener('click', () => checkAnswer(i + 1));
                optionsContainer.appendChild(optionDiv);
            }
            document.getElementById('questionContainer').style.display = 'block';
        }

        // Función para verificar la respuesta
        function checkAnswer(selectedOption) {
            const feedback = document.getElementById('feedback');
            if (selectedOption === currentMarker.correctOption) {
                feedback.innerText = "¡Correcto! +1 punto";
                score++;
                document.getElementById('score').innerText = "Puntos: " + score;
            } else {
                feedback.innerText = "Incorrecto. Inténtalo de nuevo.";
            }
            setTimeout(() => {
                feedback.innerText = '';
                document.getElementById('questionContainer').style.display = 'none';
                currentMarker = null;
            }, 2000);
        }

        // Función para actualizar la ubicación del usuario
        function updateUserLocation(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            checkMarkerProximity();
        }

        // Función para verificar la proximidad a los marcadores
        function checkMarkerProximity() {
            if (!userLocation) return;
            markersData.forEach(markerData => {
                const distance = calculateDistance(userLocation.lat, userLocation.lng, markerData.lat, markerData.lng);
                if (distance <= 50) { // 50 metros de radio
                    showQuestion(markerData);
                }
            });
        }

        // Geolocalización
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updateUserLocation, (error) => {
                console.error("Error al obtener la ubicación:", error);
            });
        } else {
            alert("La geolocalización no está soportada por este navegador.");
        }
    </script>
</body>
</html>
