<!DOCTYPE html>
<html>
<head>
    <title>Marcadores del Pueblo - Móvil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 400px; }
        #questionContainer {
            display: none;
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .option {
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #eee;
            cursor: pointer;
        }
        .option:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Explora el Pueblo - Móvil</h1>
    <div id="map"></div>
    <div id="questionContainer">
        <h3 id="question"></h3>
        <div id="options"></div>
        <p id="feedback"></p>
    </div>
    <p>Puntos: <span id="score">0</span></p>

    <script>
        const map = L.map('map').setView([41.5, -5.7], 13); // Coordenadas de Zamora
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let userLocation = null;
        let currentMarker = null;
        let score = 0;

        // Datos de los marcadores (deberían ser cargados desde un archivo JSON en una aplicación real)
        const markersData = [
            {
                title: "Plaza Mayor",
                description: "El corazón de Zamora",
                question: "¿Qué estilo arquitectónico predomina en la Plaza Mayor?",
                options: ["Románico", "Gótico", "Renacentista", "Barroco"],
                correctOption: 4,
                lat: 41.5021,
                lng: -5.7444
            },
            {
                title: "Catedral de Zamora",
                description: "Una joya del románico",
                question: "¿Qué elemento es característico de la Catedral de Zamora?",
                options: ["Torre", "Cúpula", "Rosetón", "Claustro"],
                correctOption: 2,
                lat: 41.5028,
                lng: -5.7433
            }
        ];

        // Función para calcular la distancia entre dos puntos (en metros)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Función para mostrar la pregunta
        function showQuestion(markerData) {
            currentMarker = markerData;
            document.getElementById('question').innerText = markerData.question;
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            for (let i = 0; i < markerData.options.length; i++) {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('option');
                optionDiv.innerText = `${i + 1}. ${markerData.options[i]}`;
                optionDiv.addEventListener('click', () => checkAnswer(i + 1));
                optionsContainer.appendChild(optionDiv);
            }
            document.getElementById('questionContainer').style.display = 'block';
        }

        // Función para verificar la respuesta
        function checkAnswer(selectedOption) {
            const feedback = document.getElementById('feedback');
            if (selectedOption === currentMarker.correctOption) {
                feedback.innerText = "¡Correcto! +1 punto";
                score++;
                document.getElementById('score').innerText = score;
            } else {
                feedback.innerText = "Incorrecto. Inténtalo de nuevo.";
            }
            setTimeout(() => {
                feedback.innerText = '';
                document.getElementById('questionContainer').style.display = 'none';
                currentMarker = null;
            }, 2000);
        }

        // Función para actualizar la ubicación del usuario
        function updateUserLocation(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            checkMarkerProximity();
        }

        // Función para verificar la proximidad a los marcadores
        function checkMarkerProximity() {
            if (!userLocation) return;
            markersData.forEach(markerData => {
                const distance = calculateDistance(userLocation.lat, userLocation.lng, markerData.lat, markerData.lng);
                if (distance <= 50) { // 50 metros de radio
                    showQuestion(markerData);
                }
            });
        }

        // Geolocalización
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updateUserLocation, (error) => {
                console.error("Error al obtener la ubicación:", error);
            });
        } else {
            alert("La geolocalización no está soportada por este navegador.");
        }
    </script>
</body>
</html>
